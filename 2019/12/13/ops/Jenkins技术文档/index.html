<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>Jenkins技术文档 | Hht&#39;s Home</title>
    <meta name="author" content="韩昊天" />
    <meta name="keywords" content="学习,记录" />
    <meta name="description" content="Jenkins技术文档，记录如何安装Jenkins和常用插件，以及如何自动化构建与建立脚本。[TOC]Jenkins技术文档Jenkins是什么?一款开源的持续集成工具, 具有自动化构建、测试和部署等功能。下载安装并使用下载 官方下载地址https://jenkins.io/download/左侧是稳定版右侧是最新版;点击图片中标黄的文件进行下载, 使用War包方式安装;安装 由于我们使用的是war包, 所以只需要丢入Tomcat的Webapp目录后启动tomcat..." />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    <link rel="alternate" href="/atom.xml" title="Hht&#39;s Home" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    
<link rel="stylesheet" href="/css/style.css">


    <!--[if lt IE 9]><style type="text/css">.nav-inner {top:0;}.author-meta {position:static;top:0;}.search-form {height:36px;}</style><script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
<meta name="generator" content="Hexo 4.2.1"></head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">Hht&#39;s Home</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item" href="/categories/java">
                <span class="nav-text">Java</span>
            </a>
        
            <a class="nav-item" href="/categories/ops">
                <span class="nav-text">Ops</span>
            </a>
        
            <a class="nav-item" href="/categories/linux">
                <span class="nav-text">Linux</span>
            </a>
        
            <a class="nav-item" href="/categories/other">
                <span class="nav-text">其他</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">标签</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">归档</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">关于</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="https://hanhaotian97.github.io/hht.github.io"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Jenkins技术文档"><span class="toc-number">1.</span> <span class="toc-text">Jenkins技术文档</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins是什么"><span class="toc-number">1.1.</span> <span class="toc-text">Jenkins是什么?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#下载安装并使用"><span class="toc-number">1.2.</span> <span class="toc-text">下载安装并使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#插件安装失败的解决方法"><span class="toc-number">1.2.1.</span> <span class="toc-text">插件安装失败的解决方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#环境部署"><span class="toc-number">1.2.2.</span> <span class="toc-text">环境部署</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构建工程"><span class="toc-number">1.3.</span> <span class="toc-text">构建工程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#普通工程-发布在本地"><span class="toc-number">1.3.1.</span> <span class="toc-text">普通工程, 发布在本地</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发布到远端Tomcat"><span class="toc-number">1.3.2.</span> <span class="toc-text">发布到远端Tomcat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过SSH传送到远端服务器"><span class="toc-number">1.3.3.</span> <span class="toc-text">通过SSH传送到远端服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#持续发布springCloud项目"><span class="toc-number">1.3.4.</span> <span class="toc-text">持续发布springCloud项目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#遇到的一些问题"><span class="toc-number">1.4.</span> <span class="toc-text">遇到的一些问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#各种插件"><span class="toc-number">1.5.</span> <span class="toc-text">各种插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#权限控制插件"><span class="toc-number">1.5.1.</span> <span class="toc-text">权限控制插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#定时备份"><span class="toc-number">1.5.2.</span> <span class="toc-text">定时备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gitlab钩子"><span class="toc-number">1.5.3.</span> <span class="toc-text">gitlab钩子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参数化构建-多选框插件"><span class="toc-number">1.5.4.</span> <span class="toc-text">参数化构建 : 多选框插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参数化构建-git分支列表插件"><span class="toc-number">1.5.5.</span> <span class="toc-text">参数化构建 : git分支列表插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Blue-Ocean插件"><span class="toc-number">1.5.6.</span> <span class="toc-text">Blue Ocean插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Git多分支拉取"><span class="toc-number">1.5.7.</span> <span class="toc-text">Git多分支拉取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Git参数化拉取"><span class="toc-number">1.5.8.</span> <span class="toc-text">Git参数化拉取</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#常用脚本"><span class="toc-number">2.</span> <span class="toc-text">常用脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#jenkins-jar-cicd"><span class="toc-number">2.1.</span> <span class="toc-text">jenkins-jar-cicd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jenkins-vue-cicd"><span class="toc-number">2.2.</span> <span class="toc-text">jenkins-vue-cicd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jenkins-jar-docker-cicd"><span class="toc-number">2.3.</span> <span class="toc-text">jenkins-jar-docker-cicd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jenkins-jar-rollback"><span class="toc-number">2.4.</span> <span class="toc-text">jenkins-jar-rollback</span></a></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
            <div id="wrapper" class="wrapper" style="max-width: 800px">
                <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            Jenkins技术文档
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://hanhaotian97.github.io/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2019-12-13T01:46:42.856Z" itemprop="datePublished">2019-12-13</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/ci-cd/" rel="tag">ci/cd</a>, <a class="article-tag-link" href="/tags/ops/" rel="tag">ops</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>Jenkins技术文档，记录如何安装Jenkins和常用插件，以及如何自动化构建与建立脚本。</p>
<a id="more"></a>


<p>[TOC]</p>
<h1 id="Jenkins技术文档"><a href="#Jenkins技术文档" class="headerlink" title="Jenkins技术文档"></a>Jenkins技术文档</h1><h2 id="Jenkins是什么"><a href="#Jenkins是什么" class="headerlink" title="Jenkins是什么?"></a>Jenkins是什么?</h2><p>一款开源的持续集成工具, 具有自动化构建、测试和部署等功能。</p>
<h2 id="下载安装并使用"><a href="#下载安装并使用" class="headerlink" title="下载安装并使用"></a>下载安装并使用</h2><ol>
<li>下载<br> 官方下载地址<a href="https://jenkins.io/download/" target="_blank" rel="noopener">https://jenkins.io/download/</a></li>
</ol>
<p><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image1.png" alt="Jenkins技术文档/image1"></p>
<p>左侧是稳定版右侧是最新版;<br>点击图片中标黄的文件进行下载, 使用War包方式安装;</p>
<ol start="2">
<li>安装<br> 由于我们使用的是war包, 所以只需要丢入Tomcat的Webapp目录后启动tomcat即可;</li>
</ol>
<p><strong>建议</strong> : 在首次启动之前, 设置环境变量JENKINS_HOME(默认为$HOME/.jenkins)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/profile</span><br><span class="line">.....</span><br><span class="line"><span class="built_in">export</span> JENKINS_HOME=/data/software/jenkins</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>启动</p>
<p>正常启动tomcat即可;   /data/project/apache-tomcat-9.0.12/bin/startup.sh</p>
<p><a href="http://centos:8080/" target="_blank" rel="noopener">访问http://192.168.10.10:8080/</a> </p>
</li>
</ol>
<ul>
<li><p>首次进入需要输入初始密码, 在页面上有提示密码文件路径</p>
<p><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image2.png" alt="images"></p>
</li>
</ul>
<ul>
<li>选择推荐的插件继续 : 由于网络原因部分插件可能会安装失败, 不用紧张在之后可以手动安装;<br>   <img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image3.png" alt="images"></li>
<li>然后设置管理员账户密码</li>
</ul>
<h3 id="插件安装失败的解决方法"><a href="#插件安装失败的解决方法" class="headerlink" title="插件安装失败的解决方法"></a>插件安装失败的解决方法</h3><p>   <img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image4.png" alt="images"><br>   如图所示有些插件初始安装失败了, 有两种安装方式.</p>
<ul>
<li>手动下载方式 :<ol>
<li>进入插件下载地址 <a href="http://updates.jenkins-ci.org/download/plugins/" target="_blank" rel="noopener">http://updates.jenkins-ci.org/download/plugins/</a></li>
<li>搜索需要安装的插件名, 如GitHub API, 进入下载所需要的版本<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image5.png" alt="images"></li>
<li>进入系统管理-&gt;管理插件-&gt;高级, 选择上传插件, 安装完成后重启即可;</li>
</ol>
</li>
</ul>
<ul>
<li>自动下载方式 : <ol>
<li>进入系统管理-&gt;管理插件-&gt;可选插件</li>
<li>搜索对应的插件<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image6.png" alt="images"></li>
</ol>
</li>
</ul>
<h3 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h3><p>在新建一个工程使用之前要对需要的工具(jdk, git, maven, gradle, docker等)进行配置;    </p>
<p>进入系统管理-&gt;全局工具配置, 需要填入命令的可执行路径, 有一些是配置中的HOME目录(如下面中jdk和gradle). </p>
<p>不知道命令的可执行路径? : type [命令名]<br> <img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image7.png" alt="images"></p>
<h2 id="构建工程"><a href="#构建工程" class="headerlink" title="构建工程"></a>构建工程</h2><h3 id="普通工程-发布在本地"><a href="#普通工程-发布在本地" class="headerlink" title="普通工程, 发布在本地"></a>普通工程, 发布在本地</h3><ol>
<li>新建任务-&gt;构建一个自由风格的软件项目, 输入任务名</li>
<li>通用 : 默认构建的项目会一直保存, 这里设置可以设置丢弃<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image8.png" alt="images"></li>
<li>源码管理 :<br> 这里使用的是gitlab, 填入git仓库地址, 用户凭证, 要拉取的分支<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image9.png" alt="images"><br> 点击add添加凭证, 输入用户名和密码, 通常ID不用填(一般是在脚本配置指定凭证时使用), 可以选择密文或秘钥的方式<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image10.png" alt="images"></li>
<li>构建触发器 :<br> 检测到git仓库有代码提交就进行一次构建(需要提供钩子)<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image11.png" alt="images"><br> 4.构建环境 : 进行自动化测试等<br> 5.构建 :<br> 由于是发布到本地中, 所以直接执行了一个脚本;</li>
</ol>
<ul>
<li>修改BUILD_ID<br>原理：jenkins默认会在构建完成后使用processTreeKiller杀掉这个工程触发的所以衍生进程(我们在脚本中创建的服务进程也会被kill掉). 根据BUILD_ID识别某个进程是否为构建过程的衍生进程, 所以修改BUILD_ID后进程能在后台保留运行.<br> <img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image12.png" alt="images"></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#构建当前目录下所有的gradle项目</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> GRADLE_HOME=/data/software/gradle-4.10.2</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$GRADLE_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> *</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="keyword">if</span> [ -d <span class="variable">$file</span> ]&amp;&amp;[ <span class="variable">$file</span> != <span class="string">"communal"</span> ];<span class="keyword">then</span></span><br><span class="line">		currentDir=$(<span class="built_in">pwd</span>)</span><br><span class="line">	</span><br><span class="line">		<span class="built_in">cd</span> <span class="variable">$file</span></span><br><span class="line">		gradle build</span><br><span class="line"></span><br><span class="line">		deploydir=/data/project/sanyuzhongsheng/<span class="variable">$file</span>/</span><br><span class="line">		<span class="keyword">if</span> [ ! -d <span class="variable">$deploydir</span>  ];<span class="keyword">then</span></span><br><span class="line">		  mkdir -p <span class="variable">$deploydir</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		cp ./build/libs/*.jar <span class="variable">$deploydir</span></span><br><span class="line">	</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">cd</span> <span class="variable">$deploydir</span></span><br><span class="line">		appName=`ls|grep .jar$`</span><br><span class="line">		appId=`ps -ef |grep java|grep <span class="variable">$appName</span>|awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">		<span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$appId</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> -n <span class="string">"The <span class="variable">$appName</span> is stopping..."</span></span><br><span class="line">			<span class="built_in">echo</span></span><br><span class="line">			<span class="built_in">kill</span> <span class="variable">$appId</span></span><br><span class="line">		</span><br><span class="line">			<span class="keyword">for</span> i <span class="keyword">in</span> &#123;3..1&#125;</span><br><span class="line">			<span class="keyword">do</span></span><br><span class="line">				<span class="built_in">echo</span> -n <span class="string">"<span class="variable">$i</span>..."</span></span><br><span class="line">				sleep 1	</span><br><span class="line">			<span class="keyword">done</span></span><br><span class="line">			<span class="built_in">echo</span> 0</span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"The <span class="variable">$appName</span> is starting..."</span></span><br><span class="line">		nohup java -jar <span class="variable">$appName</span> -XX:+UseG1GC -XX:+HeapDumpOnOutOfMemoryError -Xms512M -Xmx2G &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">cd</span> <span class="variable">$currentDir</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$file</span> build over"</span></span><br><span class="line">		<span class="built_in">echo</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li>进行构建 : 点击立即构建进行构建</li>
<li>查看构建输出 :<br> 如下图标黄中, 从git上下载的源码保存在/data/software/jenkins/workspace/xxxxx目录下,也是该工程的工作空间;<br> 最后一行输出 Finished: SUCCESS 表示构建成功<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image13.png" alt="images"><br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image14.png" alt="images"></li>
</ol>
<h3 id="发布到远端Tomcat"><a href="#发布到远端Tomcat" class="headerlink" title="发布到远端Tomcat"></a>发布到远端Tomcat</h3><p>这种属于增量发布, 其实并不太实用</p>
<ol>
<li>安装插件Deploy to container</li>
<li>其余步骤相同, 增加构建后操作操作步骤, 选择Deploy war/ear to a container; </li>
<li>WAR/EAR files : war包的相对路径, 相对于工作区根目录(无法找到上级文件夹)<br> Context path : 上下文路径<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image15.png" alt="Jenkins技术文档"></li>
<li>修改远端的Tomcat并启动<br> 由于这种方式是通过tomcat自带的管理界面进行上传部署的, 所以必须保证目标服务器处于启动状态, 并且开启了用户脚本管理权限;</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ vim conf/tomcat-users.xml</span><br><span class="line">&lt;role rolename=<span class="string">"manager-gui"</span>/&gt;</span><br><span class="line">&lt;role rolename=<span class="string">"manager-script"</span>/&gt;</span><br><span class="line">&lt;role rolename=<span class="string">"manager-jmx"</span>/&gt;</span><br><span class="line">&lt;role rolename=<span class="string">"manager-status"</span>/&gt;</span><br><span class="line"></span><br><span class="line">&lt;user username=<span class="string">"root"</span> password=<span class="string">"123456"</span> roles=<span class="string">"manager-gui,manager-script"</span>/&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>注意 : 对于非tomcat本机访问manager页面, 还需要修改访问Ip限制条件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim webapps/manager/META-INF/context.xml</span><br><span class="line"></span><br><span class="line">&lt;Context antiResourceLocking=<span class="string">"false"</span> privileged=<span class="string">"true"</span> &gt;&lt;/Context&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="5">
<li>立即构建</li>
</ol>
<h3 id="通过SSH传送到远端服务器"><a href="#通过SSH传送到远端服务器" class="headerlink" title="通过SSH传送到远端服务器"></a>通过SSH传送到远端服务器</h3><ol>
<li><p>安装插件Publish Over SSH</p>
</li>
<li><p>配置SSH连接, 系统管理—&gt;系统设置-&gt;Publish Over SSH. 建议使用认证登录;<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image16.png" alt="images"></p>
</li>
<li><p>新建工程, 与基础构建类似, </p>
</li>
<li><p>构建-执行shell : </p>
<p>以下shell操作, 将上次打包的文件删除, 然后进入子module中进行打包(gradle build), 并将打包好的文件复制到工作区根目录下.</p>
<p>${deploy}是参数化构建传过来的值, 例如:company_agent_wap,company_business_wap,company-system-back,sale_joinBusiness_wap,sale_joinBusiness_web,sale_system_back,send_goods_manage</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">rm -rf ./*.jar</span><br><span class="line"></span><br><span class="line">IFS=<span class="string">","</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$&#123;deploy&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="keyword">if</span> [ -d <span class="variable">$file</span> -a <span class="variable">$file</span> != <span class="string">"core"</span> -a <span class="variable">$file</span> != <span class="string">"common"</span> -a <span class="variable">$file</span> != <span class="string">"document"</span> -a <span class="variable">$file</span> != <span class="string">"communal"</span> ];<span class="keyword">then</span></span><br><span class="line">		<span class="comment">#项目打包</span></span><br><span class="line">		<span class="built_in">cd</span> <span class="variable">$file</span></span><br><span class="line">		gradle build</span><br><span class="line">        </span><br><span class="line">		cp ./build/libs/*.jar ../<span class="variable">$file</span>.jar</span><br><span class="line">	</span><br><span class="line">		<span class="built_in">cd</span> ../</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$file</span> build over"</span></span><br><span class="line">		<span class="built_in">echo</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 需要上传的包<span class="variable">$&#123;deploy&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>构建后操作 : 选择Send build artifacts over SSH</p>
<p>从git上拉取代码后, 会将打到的包复制到工作区根目录下, 将所有的jar文件发送到远端服务器的$HOME/jenkins-project/sanyuzhongsheng/目录下, 在目标服务器进行后续操作;</p>
<ul>
<li>默认情况下如果不存在此文件夹会创建对应的文件夹, 高级选项可以设置;</li>
</ul>
</li>
</ol>
<ul>
<li>要发送多个文件可以用逗号’,’隔开</li>
<li>[source files] 和 [Exec command]必须有一个不为空</li>
</ul>
<p>  如果source files 填写的是publish/qianyihongyuan/*.war下, 那么会将对于war包发送到目标服务器的$HOME/publish/qianyihongyuan/下<img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image17.png" alt="images"></p>
<p>  以下shell操作, 将传过来的jar包复制到一个专门发布服务的目录下, 然后分别进行发布</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">$ cat jenkins-project/sanyuzhongsheng/allDeploy.sh </span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#环境变量</span></span><br><span class="line"><span class="built_in">set</span> -eu</span><br><span class="line"></span><br><span class="line">JAVA_HOME=/usr/iqmkj/workspace/jdk1.8.0_121</span><br><span class="line">JRE_HOME=/usr/iqmkj/workspace/jdk1.8.0_121/jre</span><br><span class="line">CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar:<span class="variable">$JRE_HOME</span>/lib</span><br><span class="line">PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH JAVA_HOME CLASSPATH</span><br><span class="line"></span><br><span class="line">projectName=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$projectName</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"parameter deletion!"</span></span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">currentDir=/root/jenkins-project/<span class="variable">$projectName</span>/</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$currentDir</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> *.jar</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	fileName=<span class="variable">$&#123;file%.jar&#125;</span></span><br><span class="line">	</span><br><span class="line">	deployDir=/data/project/<span class="variable">$projectName</span>/<span class="variable">$fileName</span>/</span><br><span class="line">	<span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$deployDir</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">	  mkdir -p <span class="variable">$deployDir</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">	cp <span class="variable">$currentDir</span><span class="variable">$file</span> <span class="variable">$deployDir</span></span><br><span class="line">	</span><br><span class="line">	<span class="built_in">cd</span> <span class="variable">$deployDir</span></span><br><span class="line">	<span class="comment"># 停止服务</span></span><br><span class="line">	appId=`ps -ef |grep java|grep <span class="variable">$file</span>|awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">	<span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$appId</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> -n <span class="string">"The <span class="variable">$file</span> is stopping..."</span></span><br><span class="line">		<span class="built_in">echo</span></span><br><span class="line">		<span class="built_in">kill</span> <span class="variable">$appId</span></span><br><span class="line">	</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> &#123;3..1&#125;</span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">			<span class="built_in">echo</span> -n <span class="string">"<span class="variable">$i</span>..."</span></span><br><span class="line">			sleep 1	</span><br><span class="line">		<span class="keyword">done</span></span><br><span class="line">		<span class="built_in">echo</span> 0</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># 启动服务</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"The <span class="variable">$file</span> is starting..."</span></span><br><span class="line">	nohup java -jar <span class="variable">$deployDir</span><span class="variable">$file</span> -Djava.security.egd=file:/dev/./urandom &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>


<h3 id="持续发布springCloud项目"><a href="#持续发布springCloud项目" class="headerlink" title="持续发布springCloud项目"></a>持续发布springCloud项目</h3><p>其实和springboot项目的发布一样, springCloud并不影响springBoot的结构</p>
<ol>
<li><p>新建任务-&gt;选择构建一个自由风格的软件项目</p>
</li>
<li><p>general-&gt;GitHub项目</p>
<p>地址 : <a href="https://github.com/hanhaotian97/springCloudDemo/" target="_blank" rel="noopener">https://github.com/hanhaotian97/springCloudDemo/</a></p>
<p><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image26.png" alt="images"></p>
</li>
</ol>
<p>   源码管理-&gt;git 也使用这个地址</p>
<ol start="3">
<li><p>构建-&gt;执行shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">rm -rf ./*.jar</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> *</span><br><span class="line"><span class="keyword">do</span>	</span><br><span class="line">	<span class="keyword">if</span> [ -d <span class="variable">$file</span> -a <span class="variable">$file</span> != <span class="string">"core"</span> -a <span class="variable">$file</span> != <span class="string">"common"</span> -a <span class="variable">$file</span> != <span class="string">"document"</span> -a <span class="variable">$file</span> != <span class="string">"communal"</span> ];<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">cd</span> <span class="variable">$file</span></span><br><span class="line">		<span class="keyword">if</span> [ ! -f <span class="string">"build.gradle"</span> ]; <span class="keyword">then</span></span><br><span class="line">			<span class="built_in">cd</span> ../</span><br><span class="line">			<span class="built_in">continue</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">#项目打包</span></span><br><span class="line">		gradle build</span><br><span class="line">        </span><br><span class="line">		cp ./build/libs/*.jar ../<span class="variable">$file</span>.jar</span><br><span class="line">	</span><br><span class="line">		<span class="built_in">cd</span> ../</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$file</span> build over"</span></span><br><span class="line">		<span class="built_in">echo</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>构建后操作-&gt;Send build artifacts over SSH-&gt;SSH Server-&gt;Transfers-&gt;Exec command</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">project=springCloud-demo</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> jenkins-project/<span class="variable">$project</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>  [ ! -f <span class="string">"<span class="variable">$project</span>.sh"</span> ];<span class="keyword">then</span></span><br><span class="line">        cat ../baseDeploy.sh &gt; <span class="variable">$project</span>.sh</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -x <span class="string">"<span class="variable">$project</span>.sh"</span> ];<span class="keyword">then</span></span><br><span class="line">        chmod +x <span class="variable">$project</span>.sh</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">./<span class="variable">$project</span>.sh</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>只要提前创建baseDeploy.sh, 再创建其他工程时, 只需要修改上面代码中的project参数;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── anaconda-ks.cfg</span><br><span class="line">├── auth.smb</span><br><span class="line">└── jenkins-project</span><br><span class="line">    ├── baseDeploy.sh</span><br><span class="line">    └── springCloud-demo</span><br><span class="line">        └── springCloud-demo.sh</span><br><span class="line"></span><br><span class="line">2 directories, 4 files</span><br><span class="line"></span><br><span class="line">[root@localhost jenkins-project]$ cat ./jenkins-project/baseDeploy.sh </span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#环境变量</span></span><br><span class="line">JAVA_HOME=/data/software/jdk1.8.0_181</span><br><span class="line">CLASSPATH=<span class="variable">$JAVA_HOME</span>/lib/</span><br><span class="line">PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"><span class="built_in">export</span> PATH JAVA_HOME CLASSPATH</span><br><span class="line"></span><br><span class="line">projectName=$(ls | grep .sh)</span><br><span class="line">projectName=<span class="variable">$&#123;projectName%.sh&#125;</span></span><br><span class="line">currentDir=~/jenkins-project/<span class="variable">$projectName</span>/</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$currentDir</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> *.jar</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	fileName=<span class="variable">$&#123;file%.jar&#125;</span></span><br><span class="line">	deployDir=/data/project/<span class="variable">$projectName</span>/<span class="variable">$fileName</span>/</span><br><span class="line">	<span class="keyword">if</span> [ ! -e <span class="variable">$deployDir</span>  ];<span class="keyword">then</span></span><br><span class="line">	  mkdir -p <span class="variable">$deployDir</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">	mv <span class="variable">$currentDir</span><span class="variable">$file</span> <span class="variable">$deployDir</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">cd</span> <span class="variable">$deployDir</span></span><br><span class="line">	<span class="comment"># 停止服务</span></span><br><span class="line">	appId=`ps -ef |grep java|grep <span class="variable">$file</span>|awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">	<span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$appId</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> -n <span class="string">"The <span class="variable">$file</span> is stopping..."</span></span><br><span class="line">		<span class="built_in">echo</span></span><br><span class="line">		<span class="built_in">kill</span> <span class="variable">$appId</span></span><br><span class="line">	</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> &#123;3..1&#125;</span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">			<span class="built_in">echo</span> -n <span class="string">"<span class="variable">$i</span>..."</span></span><br><span class="line">			sleep 1	</span><br><span class="line">		<span class="keyword">done</span></span><br><span class="line">		<span class="built_in">echo</span> 0</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 启动服务</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"The <span class="variable">$file</span> is starting..."</span></span><br><span class="line">	nohup java -jar <span class="variable">$deployDir</span><span class="variable">$file</span> &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>查看效果</p>
<p>访问 : <a href="http://192.168.10.20:8761/" target="_blank" rel="noopener">http://192.168.10.20:8761/</a></p>
<p><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image27.png" alt="images/image27.png"></p>
<p>访问 : </p>
<p><a href="http://192.168.10.20:8080/port" target="_blank" rel="noopener">http://192.168.10.20:8080/port</a></p>
<p><a href="http://192.168.10.20:8081/getClientPort" target="_blank" rel="noopener">http://192.168.10.20:8081/getClientPort</a></p>
<p><a href="http://192.168.10.20:8082/getPortInfo" target="_blank" rel="noopener">http://192.168.10.20:8082/getPortInfo</a></p>
<p><a href="http://192.168.10.20:8083/getPortInfo" target="_blank" rel="noopener">http://192.168.10.20:8083/getPortInfo</a></p>
<p>页面上全部显示 hello world from port 8080, this eureka client</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ps aux | grep java</span></span><br><span class="line">root       2512  0.4 14.7 2330856 147092 ?      Sl   17:22   0:17 java -jar /data/project/springCloud-demo/eureka-client/eureka-client.jar</span><br><span class="line">root       2522  1.0 20.0 2366492 200096 ?      Sl   17:22   0:40 java -jar /data/project/springCloud-demo/eureka-service/eureka-service.jar</span><br><span class="line">root       2556  0.4 12.4 2340016 124060 ?      Sl   17:22   0:15 java -jar /data/project/springCloud-demo/feign-demo/feign-demo.jar</span><br><span class="line">root       2565  0.4 11.1 2328808 111352 ?      Sl   17:22   0:15 java -jar /data/project/springCloud-demo/hystrix-demo/hystrix-demo.jar</span><br><span class="line">root       2597  0.3 12.2 2331436 122000 ?      Sl   17:22   0:14 java -jar /data/project/springCloud-demo/ribbon-demo/ribbon-demo.jar</span><br><span class="line">root       2875  0.0  0.0 112720   984 pts/0    R+   18:23   0:00 grep --color=auto java</span><br><span class="line">[root@localhost ~]<span class="comment"># kill 2512</span></span><br></pre></td></tr></table></figure>

<p>关闭客户端进程后, 重新访问, 发现除了<a href="http://192.168.10.20:8083/getPortInfo显示&#39;getPost()服务不可用...&#39;" target="_blank" rel="noopener">http://192.168.10.20:8083/getPortInfo显示&#39;getPost()服务不可用...&#39;</a>, 其余全部不可访问</p>
</li>
</ol>
<ul>
<li>持续发布springCloud项目脚本</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 持续集成</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d ./publish/ ];<span class="keyword">then</span></span><br><span class="line">	mkdir ./publish/</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">prefix=springcloud-demo</span><br><span class="line"></span><br><span class="line">IFS=<span class="string">","</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$&#123;buildProject&#125;</span></span><br><span class="line"><span class="keyword">do</span>	</span><br><span class="line">	<span class="keyword">if</span> [ -d <span class="variable">$file</span> -a <span class="variable">$file</span> != <span class="string">"core"</span> -a <span class="variable">$file</span> != <span class="string">"common"</span> -a <span class="variable">$file</span> != <span class="string">"document"</span> -a <span class="variable">$file</span> != <span class="string">"communal"</span> ];<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">cd</span> <span class="variable">$file</span></span><br><span class="line">		<span class="comment">#项目打包</span></span><br><span class="line">		<span class="keyword">if</span> [ ! -f <span class="string">"build.gradle"</span> ]; <span class="keyword">then</span></span><br><span class="line">			<span class="built_in">cd</span> ../</span><br><span class="line">			<span class="built_in">continue</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		gradle bootRepackage</span><br><span class="line">		</span><br><span class="line">		<span class="comment">#设置端口映射</span></span><br><span class="line">		portMapper=<span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$file</span> = <span class="string">"eureka-client"</span> ];<span class="keyword">then</span></span><br><span class="line">			portMapper=8080:8080</span><br><span class="line">		<span class="keyword">elif</span> [ <span class="variable">$file</span> = <span class="string">"ribbon-demo"</span> ];<span class="keyword">then</span></span><br><span class="line">			portMapper=8081:8081</span><br><span class="line">		<span class="keyword">elif</span> [ <span class="variable">$file</span> = <span class="string">"feign-demo"</span> ];<span class="keyword">then</span></span><br><span class="line">			portMapper=8082:8082</span><br><span class="line">		<span class="keyword">elif</span> [ <span class="variable">$file</span> = <span class="string">"hystrix-demo"</span> ];<span class="keyword">then</span></span><br><span class="line">			portMapper=8083:8083</span><br><span class="line">		<span class="keyword">elif</span> [ <span class="variable">$file</span> = <span class="string">"eureka-service"</span> ];<span class="keyword">then</span></span><br><span class="line">			portMapper=8761:8761</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">"portMapper setting fail"</span></span><br><span class="line">			<span class="built_in">exit</span> 1</span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">		<span class="comment">#删除上次的镜像和容器</span></span><br><span class="line">        imageId=$(docker images|grep -i <span class="variable">$file</span>|awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line">		containerId=$(docker ps -a |grep -i <span class="variable">$file</span>|awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">        <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$imageId</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">"删除镜像<span class="variable">$imageId</span>"</span></span><br><span class="line">			<span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$containerId</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">				 <span class="built_in">echo</span> <span class="string">"删除容器<span class="variable">$containerId</span>"</span></span><br><span class="line">				 docker stop <span class="variable">$containerId</span></span><br><span class="line">				 docker rm <span class="variable">$containerId</span></span><br><span class="line">			<span class="keyword">fi</span></span><br><span class="line">			docker rmi -f <span class="variable">$imageId</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">		<span class="comment">#构建镜像,启动容器</span></span><br><span class="line">        time=`date -d <span class="string">"today"</span> +<span class="string">"%Y%m%d_%H%M%S"</span>`</span><br><span class="line">        docker build -t <span class="variable">$prefix</span>/<span class="variable">$file</span>:<span class="variable">$time</span> .</span><br><span class="line">        docker run -d -p <span class="variable">$portMapper</span> -v /data/docker-project/<span class="variable">$file</span>:/data/logs --privileged=<span class="literal">true</span> --name <span class="variable">$file</span> <span class="variable">$prefix</span>/<span class="variable">$file</span>:<span class="variable">$time</span></span><br><span class="line">		</span><br><span class="line">		<span class="built_in">cd</span> ../</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="遇到的一些问题"><a href="#遇到的一些问题" class="headerlink" title="遇到的一些问题"></a>遇到的一些问题</h2><ol>
<li><p>明明成功启动了服务, 监控进程也能看见, 但是在很短的时间后就消失了<br> 进程被杀掉了, 需要修改BUILD_ID=DONTKILLME, 防止jenkins杀死启动的衍生进程</p>
</li>
<li><p>构建失败 : 在执行脚本时, command not found<br> jenkins执行的脚本默认是使用非登录方式, 并没有从profile中读取环境变量, 手动在shell中export环境变量即可(或者在脚本中使用登录方式, 首行修改为#!/bin/sh -l)</p>
</li>
<li><p>新建的项目拉取源码时间过长, 导致构建失败<br> 拉取时间默认10分钟, 超时导致失败; 设置timeout, 在工程配置-&gt;源码管理-&gt;git-&gt;    Additional Behaviours, 修改Timeout (in minutes) for clone and fetch operations的值为20</p>
</li>
<li><p>构建失败 : 在拉取代码时出现错误”Could not resolve host: git.minedatainfo.com; Unknown error”, 由于DNS解析网址错误或超时导致的失败, 需要手动修改host文件添加解析;</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/hosts</span><br><span class="line">154.223.40.12 minedatainfo.com`</span><br></pre></td></tr></table></figure>
</li>
<li><p>构建成功但代码未被修改 : jenkins服务器时间与git服务器时间不一致导致<br> 修改时区 timedatectl set-timezone Asia/Shanghai<br> ll /etc/localtime<br> 同步时间 /usr/sbin/ntpdate cn.pool.ntp.org &amp;&amp; hwclock -s<br> 再次构建, 能正常看到被修改的代码了</p>
</li>
<li><p>jenkins服务时区不正确 : 在[系统管理]-&gt;[脚本命令行], 输入System.setProperty(‘org.apache.commons.jelly.tags.fmt.timeZone’, ‘Asia/Shanghai’)</p>
</li>
</ol>
<h2 id="各种插件"><a href="#各种插件" class="headerlink" title="各种插件"></a>各种插件</h2><h3 id="权限控制插件"><a href="#权限控制插件" class="headerlink" title="权限控制插件"></a>权限控制插件</h3><ol>
<li><p>安装插件Role-based Authorization Strategy</p>
</li>
<li><p>系统管理-&gt;全局安全配置-&gt;开启Role-Based Strategy</p>
</li>
<li><p>进入系统管理-&gt;Manage and Assign Roles<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image18.png" alt="images"></p>
</li>
<li><p>Manage Roles管理角色权限<br> 下图设置了开发和测试两个角色, 去除了系统设置权限和所有的删除权限;<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image19.png" alt="images"><br>除了按用户-角色分, 也可以指定用户-项目的权限(按项目角色名正则匹配); 同时还能控制新增工程的命名规则;<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image20.png" alt="images"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Manage Roles的项目角色正则 : </span><br><span class="line"> (?i).*dev : 匹配以dev结尾的项目,不区分大小写</span><br><span class="line"> dev.* : 匹配以dev开头的项目</span><br><span class="line"> dev|prod : 匹配dev和prod两个项目</span><br></pre></td></tr></table></figure>
</li>
<li><p>Assign Roles管理用户-角色权限<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image21.png" alt="images"></p>
</li>
<li><p>工程命名限制<br>进入系统管理-&gt;工程命名限制;<br>Role-Based Strategy : 根据设置的角色权限限制命名, 全局角色除外;<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image22.png" alt="images"></p>
</li>
</ol>
<h3 id="定时备份"><a href="#定时备份" class="headerlink" title="定时备份"></a>定时备份</h3><ol>
<li>安装插件thinbackup</li>
<li>进入系统管理-&gt;ThinBackup</li>
</ol>
<h3 id="gitlab钩子"><a href="#gitlab钩子" class="headerlink" title="gitlab钩子"></a>gitlab钩子</h3><ol>
<li>安装插件 Generic Webhook Trigger Plugin</li>
<li>配置API Token : 系统管理–管理用户–用户列表–admin 设置api token</li>
<li>配置gitlab的webhook触发地址 : 进入gitlab项目-setting(设置)-Integrations(集成)-设置触发网址与触发操作(在GitLab 11.3中引入了分支过滤)<br><code>http://&lt;User ID&gt;:&lt;API Token&gt;@&lt;Jenkins IP地址&gt;:端口/generic-webhook-trigger/invoke</code><br><code>例如 : http://root:11092ec3a96750721fc455a56192e7a5ec@jenkins.youbuxinxi.com/jenkins/generic-webhook-trigger/invoke</code></li>
<li>jenkins配置构建触发器-Generic Webhook Trigger</li>
<li>通过设置Generic Webhook Trigger - Token来触发唯一的任务</li>
</ol>
<h3 id="参数化构建-多选框插件"><a href="#参数化构建-多选框插件" class="headerlink" title="参数化构建 : 多选框插件"></a>参数化构建 : 多选框插件</h3><ol>
<li>安装插件Extended Choice Parameter</li>
<li>项目构建配置-&gt;General-&gt;勾选参数化构建过程-&gt;选择Extended Choice Parameter</li>
<li>下图分别是配置和效果<br> 如何使用输入的参数 : ${deploy}<br> 下面设置了待选择的值, 以及这些值的分隔符, 默认值;<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image23.png" alt="images"><br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image24.png" alt="images"></li>
</ol>
<h3 id="参数化构建-git分支列表插件"><a href="#参数化构建-git分支列表插件" class="headerlink" title="参数化构建 : git分支列表插件"></a>参数化构建 : git分支列表插件</h3><p>根据获取设定的规则获取git分支列表</p>
<ol>
<li><p>安装插件Git Parameter</p>
</li>
<li><p>进入项目配置-&gt;参数化构建-&gt;Git Parameter<br><img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image28.png" alt="images"></p>
</li>
<li><p>保存, 进行参数化构建时选择要拉取分支进行构建</p>
<h3 id="Blue-Ocean插件"><a href="#Blue-Ocean插件" class="headerlink" title="Blue Ocean插件"></a>Blue Ocean插件</h3></li>
</ol>
<p>1.安装插件Blue Ocean<br>2.打开Blue Ocean<br>   <img src="/hht.github.io/2019/12/13/ops/Jenkins%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/image25.png" alt="images"></p>
<h3 id="Git多分支拉取"><a href="#Git多分支拉取" class="headerlink" title="Git多分支拉取"></a>Git多分支拉取</h3><ol>
<li>安装插件multiple-scms</li>
<li>在源码管理处选择Multiple SCMs</li>
<li>拉取多个git要指定[Additional Behaviours], 选择[Check out to a sub-directory]输入拉取到的子文件夹</li>
</ol>
<h3 id="Git参数化拉取"><a href="#Git参数化拉取" class="headerlink" title="Git参数化拉取"></a>Git参数化拉取</h3><ol>
<li>安装插件Git Parameter</li>
<li>进入项目配置-&gt;参数化构建-&gt;Git Parameter</li>
</ol>
<h1 id="常用脚本"><a href="#常用脚本" class="headerlink" title="常用脚本"></a>常用脚本</h1><h2 id="jenkins-jar-cicd"><a href="#jenkins-jar-cicd" class="headerlink" title="jenkins-jar-cicd"></a>jenkins-jar-cicd</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#####################################################################################################################################</span></span><br><span class="line"><span class="comment">##java-发布到本机服务器上(多模块)</span></span><br><span class="line"><span class="comment">##参数化构建解释 : </span></span><br><span class="line"><span class="comment">#	module : 使用的是多选框check boxes, 要构建/回滚的模块, 勾选几个模块则构建/回滚几个模块</span></span><br><span class="line"><span class="built_in">export</span> BUILD_ID=DONTKILLME</span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">" ./publish"</span> ]; <span class="keyword">then</span></span><br><span class="line">	mkdir -p ./publish</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">rm -rf ./publish/*.jar</span><br><span class="line"></span><br><span class="line">time=`date -d <span class="string">"today"</span> +<span class="string">"%Y%m%d_%H%M%S"</span>`</span><br><span class="line">IFS=<span class="string">","</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$&#123;module&#125;</span>; <span class="keyword">do</span></span><br><span class="line">		<span class="comment">#项目打包</span></span><br><span class="line">		<span class="built_in">cd</span> <span class="variable">$file</span></span><br><span class="line">		<span class="keyword">if</span> [ ! -f <span class="string">"build.gradle"</span> ]; <span class="keyword">then</span></span><br><span class="line">			<span class="built_in">cd</span> ../</span><br><span class="line">			<span class="built_in">continue</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		gradle clean</span><br><span class="line">		gradle build</span><br><span class="line">        </span><br><span class="line">        moduleDir=<span class="string">"/data/project/sanyuzhongsheng2.0.0/<span class="variable">$file</span>"</span></span><br><span class="line">        <span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$moduleDir</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        	mkdir -p <span class="variable">$moduleDir</span>/backup</span><br><span class="line">            ln -s /data/project/app2.sh <span class="variable">$moduleDir</span>/app2.sh</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">cd</span> <span class="variable">$moduleDir</span></span><br><span class="line">		<span class="comment">#cp ./build/libs/*.jar ../publish/$file.jar</span></span><br><span class="line">        <span class="comment">#备份</span></span><br><span class="line">        projectRunning=`ls -t | grep jar | head -n 1`</span><br><span class="line">        <span class="keyword">if</span> [ -e <span class="string">"<span class="variable">$projectRunning</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        	cp <span class="variable">$moduleDir</span>/*.jar <span class="variable">$moduleDir</span>/backup/</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="comment">#发布</span></span><br><span class="line">        	<span class="comment">## 停止服务</span></span><br><span class="line">        appId=`ps -ef |grep java|grep <span class="variable">$projectRunning</span>|awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$appId</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">            <span class="built_in">kill</span> <span class="variable">$appId</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> &#123;5..1&#125;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">                sleep 1	</span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        	<span class="comment">## 启动服务</span></span><br><span class="line">        rm -f <span class="variable">$moduleDir</span>/*.jar</span><br><span class="line">        cp <span class="variable">$&#123;WORKSPACE&#125;</span>/<span class="variable">$file</span>/build/libs/*.jar <span class="variable">$moduleDir</span>/<span class="variable">$file</span><span class="string">"_"</span><span class="variable">$time</span>.jar</span><br><span class="line">        nohup java -jar <span class="variable">$file</span><span class="string">"_"</span><span class="variable">$time</span>.jar -Djava.security.egd=file:/dev/urandom -XX:+UseG1GC -XX:+HeapDumpOnOutOfMemoryError -Xms512M -Xmx4G &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">        </span><br><span class="line">		<span class="built_in">cd</span> <span class="variable">$&#123;WORKSPACE&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"本次发布的模块有:<span class="variable">$&#123;module&#125;</span>"</span></span><br><span class="line"><span class="comment">####################################################################################################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">####################################################################################################################################</span></span><br><span class="line"><span class="comment">##java-发布到其他服务器上(多模块)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># jenkins机器上执行的shell</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"><span class="built_in">export</span> BUILD_ID=DONTKILLME</span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">" ./publish"</span> ]; <span class="keyword">then</span></span><br><span class="line">	mkdir -p ./publish</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">rm -rf ./publish/*.jar</span><br><span class="line"></span><br><span class="line">IFS=<span class="string">","</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$&#123;module&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">		<span class="comment">#项目打包</span></span><br><span class="line">		<span class="built_in">cd</span> <span class="variable">$file</span></span><br><span class="line">		<span class="keyword">if</span> [ ! -f <span class="string">"build.gradle"</span> ]; <span class="keyword">then</span></span><br><span class="line">			<span class="built_in">cd</span> <span class="variable">$&#123;WORKSPACE&#125;</span></span><br><span class="line">			<span class="built_in">continue</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		gradle clean</span><br><span class="line">		gradle build</span><br><span class="line">        </span><br><span class="line">		mv ./build/libs/*.jar ../publish/<span class="variable">$file</span>.jar</span><br><span class="line">		<span class="built_in">cd</span> <span class="variable">$&#123;WORKSPACE&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"本次发布的模块有:<span class="variable">$&#123;module&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">#SSH Publishers : 目标服务器上执行的shell(多模块)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">projectName=<span class="string">"ybxx_fd1.0"</span>;</span><br><span class="line"><span class="built_in">cd</span> jenkins-project</span><br><span class="line"><span class="keyword">for</span> moduleName <span class="keyword">in</span> $(ls <span class="variable">$projectName</span>/publish/); <span class="keyword">do</span> </span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$&#123;moduleName%.*&#125;</span> == <span class="string">"user"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># 开启远程debug模式添加参数--debug-port 5005</span></span><br><span class="line">        ./delopyForPort.sh -p ybxx_fd1.0 -s user -P 18083 -c prod</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$&#123;moduleName%.*&#125;</span> == <span class="string">"applet"</span> ]; <span class="keyword">then</span></span><br><span class="line">        ./delopyForPort.sh -p ybxx_fd1.0 -s applet -P 18084 -c prod</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"本次构建拉取的git hash值为 : "</span><span class="variable">$GIT_PREVIOUS_COMMIT</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost project]<span class="comment"># cat /root/jenkins-project/delopyForPort.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">JAVA_HOME=/data/software/jdk1.8.0_181</span><br><span class="line">JRE_HOME=<span class="variable">$JAVA_HOME</span>/jre</span><br><span class="line">CLASSPATH=<span class="variable">$JAVA_HOME</span>/lib/:<span class="variable">$JRE_HOME</span>/lib/</span><br><span class="line">PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"><span class="built_in">readonly</span> PROG=<span class="string">"`basename <span class="variable">$0</span>`"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">usage</span></span>() &#123;</span><br><span class="line">    &gt; /dev/stderr cat &lt;&lt;EOF</span><br><span class="line">Usage: <span class="variable">$0</span> [OPTION]... </span><br><span class="line"></span><br><span class="line">Example: </span><br><span class="line">    <span class="variable">$0</span> --project-name pm --server-name user</span><br><span class="line"></span><br><span class="line">Output control:</span><br><span class="line">    -p, --project-name &lt;java project name&gt;      find current dir;</span><br><span class="line">    -s, --server-name &lt;java project name&gt;       find &lt;java project name&gt;/publish/xxx.jar file;</span><br><span class="line">    -P, --server-port &lt;port&gt;                    指定端口号</span><br><span class="line">    -c, --spring-profiles-active &lt;str&gt;          指定配置文件</span><br><span class="line">    -d, --debug-port &lt;port&gt;                     指定debug服务的端口号</span><br><span class="line">Miscellaneous:</span><br><span class="line">    -h, --<span class="built_in">help</span>                                  display this <span class="built_in">help</span> and <span class="built_in">exit</span>.</span><br><span class="line">EOF</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 获取参数</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">ARGS=`getopt -o p:s:P:d:c:h -a -l <span class="built_in">help</span>,project-name:,server-name:,server-port:,spring-profiles-active:,debug-port: -n <span class="string">"<span class="variable">$PROG</span>"</span> -- <span class="string">"<span class="variable">$@</span>"</span>`</span><br><span class="line">[ $? -ne 0 ] &amp;&amp; &#123; <span class="built_in">echo</span>; usage 1; &#125;</span><br><span class="line"><span class="built_in">eval</span> <span class="built_in">set</span> -- <span class="string">"<span class="variable">$&#123;ARGS&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">    -p|--project-name)</span><br><span class="line">        projectName=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">        <span class="built_in">shift</span> 2;;</span><br><span class="line">    -s|--server-name)</span><br><span class="line">        serverName=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">        <span class="built_in">shift</span> 2;;</span><br><span class="line">    -P|--server-port)</span><br><span class="line">        projectPort=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">        <span class="built_in">shift</span> 2;;</span><br><span class="line">    -c|--spring-profiles-active)</span><br><span class="line">        profiles_active=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">        <span class="built_in">shift</span> 2;;</span><br><span class="line">    -d|--debug-port)</span><br><span class="line">        debug_port=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">        <span class="built_in">shift</span> 2;;</span><br><span class="line">    -h|--<span class="built_in">help</span>)</span><br><span class="line">        usage;;</span><br><span class="line">    --)</span><br><span class="line">        <span class="built_in">shift</span></span><br><span class="line">        <span class="built_in">break</span>;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">param_pre=<span class="string">""</span></span><br><span class="line">param_post=<span class="string">"-Djava.security.egd=file:/dev/urandom -XX:+UseG1GC -XX:+HeapDumpOnOutOfMemoryError -Xms128M -Xmx512M "</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$projectName</span>"</span> ] || [ -z <span class="string">"<span class="variable">$serverName</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"ERROR : option [-p] [-s] must exist!"</span></span><br><span class="line">    usage</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$profiles_active</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    param_post=<span class="variable">$param_post</span><span class="string">" --spring.profiles.active=<span class="variable">$profiles_active</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$projectPort</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    param_post=<span class="variable">$param_post</span><span class="string">" --server.port=<span class="variable">$projectPort</span> "</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$debug_port</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    param_pre=<span class="variable">$param_pre</span><span class="string">" -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=<span class="variable">$debug_port</span> "</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">deployFile=/root/jenkins-project/<span class="variable">$projectName</span>/publish/<span class="variable">$serverName</span>.jar</span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">"<span class="variable">$deployFile</span>"</span> ] ;<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"ERROR : source file [<span class="variable">$deployFile</span>] don't exist!"</span>;</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">time=`date -d <span class="string">"today"</span> +<span class="string">"%Y%m%d_%H%M%S"</span>`</span><br><span class="line">targetFileName=<span class="variable">$projectName</span><span class="string">"_"</span><span class="variable">$serverName</span><span class="string">"_"</span><span class="variable">$time</span><span class="string">".jar"</span>   <span class="comment"># 目标jar文件</span></span><br><span class="line">deployDir=/data/project/<span class="variable">$projectName</span>/<span class="variable">$serverName</span>   <span class="comment"># 目标文件夹</span></span><br><span class="line"><span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$deployDir</span>/backup"</span>  ];<span class="keyword">then</span></span><br><span class="line">    mkdir -p <span class="variable">$deployDir</span>/backup/</span><br><span class="line">    <span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$deployDir</span>/app.sh"</span> ]; <span class="keyword">then</span></span><br><span class="line">        ln -s /data/project/app2.sh <span class="variable">$deployDir</span>/app.sh</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line">appId=`ps -ef |grep java|grep <span class="variable">$projectName</span><span class="string">"_"</span><span class="variable">$serverName</span>|awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$appId</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">kill</span> <span class="variable">$appId</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"stop server "</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> &#123;8..1&#125;; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$i</span>..."</span>;</span><br><span class="line">        sleep 1</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$deployDir</span>/*.jar  ];<span class="keyword">then</span></span><br><span class="line">    mv <span class="variable">$deployDir</span>/*.jar <span class="variable">$deployDir</span>/backup/</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">mv <span class="variable">$deployFile</span> <span class="variable">$deployDir</span>/<span class="variable">$targetFileName</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$deployDir</span></span><br><span class="line">nohup java <span class="variable">$param_pre</span> -jar <span class="variable">$targetFileName</span> <span class="variable">$param_post</span> &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">####################################################################################################################################</span></span><br></pre></td></tr></table></figure>

<h2 id="jenkins-vue-cicd"><a href="#jenkins-vue-cicd" class="headerlink" title="jenkins-vue-cicd"></a>jenkins-vue-cicd</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">####################################################################################################################################</span></span><br><span class="line"><span class="comment">##vue 发布到其他服务器上(多模块)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># jenkins机器上执行的shell</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line">IFS=<span class="string">","</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span>  <span class="variable">$&#123;module&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="comment">#npm install</span></span><br><span class="line">    yarn</span><br><span class="line">    npm run build</span><br><span class="line">    <span class="built_in">cd</span> ../</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> 构建的模块有<span class="variable">$&#123;module&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 目标机器上执行的shell</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">time=`date -d <span class="string">"today"</span> +<span class="string">"%Y%m%d_%H%M%S"</span>`</span><br><span class="line">sourceDir=jenkins-project/<span class="built_in">test</span>/test_dist</span><br><span class="line">targetDir=/data/project/<span class="built_in">test</span>/test_dist</span><br><span class="line"><span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$targetDir</span>/dist"</span> ] ; <span class="keyword">then</span></span><br><span class="line">    mkdir -p <span class="variable">$targetDir</span>/dist</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># 删除原静态资源</span></span><br><span class="line">rm -rf <span class="variable">$targetDir</span>/dist/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制并备份新静态资源</span></span><br><span class="line">mkdir <span class="variable">$targetDir</span>/dist<span class="variable">$time</span></span><br><span class="line">cp -r <span class="variable">$sourceDir</span>/* <span class="variable">$targetDir</span>/dist</span><br><span class="line">cp -r <span class="variable">$sourceDir</span>/* <span class="variable">$targetDir</span>/dist<span class="variable">$time</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 已备份文件大于限制数, 删除最旧的</span></span><br><span class="line"><span class="keyword">if</span> [ $(ls -l <span class="variable">$targetDir</span> | grep <span class="string">'^d'</span> | wc -l) -gt 10 ]; <span class="keyword">then</span> </span><br><span class="line">    rm -rf <span class="variable">$targetDir</span>/$(ls -tr <span class="variable">$targetDir</span> | head -1)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"本次构建拉取的git hash值为 : "</span><span class="variable">$GIT_PREVIOUS_COMMIT</span></span><br><span class="line"><span class="comment">####################################################################################################################################</span></span><br></pre></td></tr></table></figure>

<h2 id="jenkins-jar-docker-cicd"><a href="#jenkins-jar-docker-cicd" class="headerlink" title="jenkins-jar-docker-cicd"></a>jenkins-jar-docker-cicd</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 持续集成</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d ./publish/ ];<span class="keyword">then</span></span><br><span class="line">	mkdir ./publish/</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">prefix=springcloud-demo</span><br><span class="line">portMapper=8081:8080</span><br><span class="line">IFS=<span class="string">","</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$&#123;buildProject&#125;</span></span><br><span class="line"><span class="keyword">do</span>	</span><br><span class="line">	<span class="keyword">if</span> [ -d <span class="variable">$file</span> -a <span class="variable">$file</span> != <span class="string">"core"</span> -a <span class="variable">$file</span> != <span class="string">"common"</span> -a <span class="variable">$file</span> != <span class="string">"document"</span> -a <span class="variable">$file</span> != <span class="string">"communal"</span> ];<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">cd</span> <span class="variable">$file</span></span><br><span class="line">		<span class="comment">#项目打包</span></span><br><span class="line">		<span class="keyword">if</span> [ ! -f <span class="string">"build.gradle"</span> ]; <span class="keyword">then</span></span><br><span class="line">			<span class="built_in">cd</span> ../</span><br><span class="line">			<span class="built_in">continue</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		gradle bootRepackage</span><br><span class="line">		</span><br><span class="line">		<span class="comment">#设置端口映射</span></span><br><span class="line">		<span class="keyword">if</span> [ <span class="variable">$file</span> = <span class="string">"eureka-client"</span> ];<span class="keyword">then</span></span><br><span class="line">			portMapper=8080:8080</span><br><span class="line">		<span class="keyword">elif</span> [ <span class="variable">$file</span> = <span class="string">"ribbon-demo"</span> ];<span class="keyword">then</span></span><br><span class="line">			portMapper=8081:8081</span><br><span class="line">		<span class="keyword">elif</span> [ <span class="variable">$file</span> = <span class="string">"feign-demo"</span> ];<span class="keyword">then</span></span><br><span class="line">			portMapper=8082:8082</span><br><span class="line">		<span class="keyword">elif</span> [ <span class="variable">$file</span> = <span class="string">"hystrix-demo"</span> ];<span class="keyword">then</span></span><br><span class="line">			portMapper=8083:8083</span><br><span class="line">		<span class="keyword">elif</span> [ <span class="variable">$file</span> = <span class="string">"eureka-service"</span> ];<span class="keyword">then</span></span><br><span class="line">			portMapper=8761:8761</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">"portMapper setting fail"</span></span><br><span class="line">			<span class="built_in">exit</span> 1</span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">		<span class="comment">#删除上次的镜像和容器</span></span><br><span class="line">        imageId=$(docker images|grep -i <span class="variable">$file</span>|awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line">		containerId=$(docker ps -a |grep -i <span class="variable">$file</span>|awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">		<span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$imageId</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">"删除镜像<span class="variable">$imageId</span>"</span></span><br><span class="line">			<span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$containerId</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">				 <span class="built_in">echo</span> <span class="string">"删除容器<span class="variable">$containerId</span>"</span></span><br><span class="line">				 docker stop <span class="variable">$containerId</span></span><br><span class="line">				 docker rm <span class="variable">$containerId</span></span><br><span class="line">			<span class="keyword">fi</span></span><br><span class="line">			docker rmi -f <span class="variable">$imageId</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		<span class="comment">#构建镜像,启动容器</span></span><br><span class="line">        time=`date -d <span class="string">"today"</span> +<span class="string">"%Y%m%d_%H%M%S"</span>`</span><br><span class="line">        docker build -t <span class="variable">$prefix</span>/<span class="variable">$file</span>:<span class="variable">$time</span> .</span><br><span class="line">        docker run -d -p <span class="variable">$portMapper</span> -v /data/docker-project/<span class="variable">$file</span>:/data/logs --privileged=<span class="literal">true</span> --name <span class="variable">$file</span> <span class="variable">$file</span>:<span class="variable">$time</span></span><br><span class="line">        </span><br><span class="line">		<span class="built_in">cd</span> ../</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#环境变量</span></span><br><span class="line">JAVA_HOME=/usr/iqmkj/workspace/jdk1.8.0_121</span><br><span class="line">JRE_HOME=/usr/iqmkj/workspace/jdk1.8.0_121/jre</span><br><span class="line">CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar:<span class="variable">$JRE_HOME</span>/lib</span><br><span class="line">PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH JAVA_HOME CLASSPATH</span><br><span class="line"><span class="built_in">export</span> BUILD_ID=DONTKILLME</span><br><span class="line"></span><br><span class="line">projectName=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$projectName</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"parameter deletion!"</span></span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">currentDir=/root/jenkins-project/<span class="variable">$projectName</span>/publish/</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$currentDir</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> *.jar</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	fileName=<span class="variable">$&#123;file%.jar&#125;</span></span><br><span class="line"></span><br><span class="line">	deployDir=/data/project/<span class="variable">$projectName</span>/<span class="variable">$fileName</span>/</span><br><span class="line">	<span class="keyword">if</span> [ ! -e <span class="variable">$deployDir</span>  ];<span class="keyword">then</span></span><br><span class="line">	  mkdir -p <span class="variable">$deployDir</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">	cp <span class="variable">$currentDir</span><span class="variable">$file</span> <span class="variable">$deployDir</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">cd</span> <span class="variable">$deployDir</span></span><br><span class="line">	<span class="comment"># 停止服务</span></span><br><span class="line">	appId=`ps -ef |grep java|grep <span class="variable">$file</span>|awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">	<span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$appId</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> -n <span class="string">"The <span class="variable">$file</span> is stopping..."</span></span><br><span class="line">		<span class="built_in">echo</span></span><br><span class="line">		<span class="built_in">kill</span> <span class="variable">$appId</span></span><br><span class="line">	</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> &#123;3..1&#125;</span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">			<span class="built_in">echo</span> -n <span class="string">"<span class="variable">$i</span>..."</span></span><br><span class="line">			sleep 1	</span><br><span class="line">		<span class="keyword">done</span></span><br><span class="line">		<span class="built_in">echo</span> 0</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 启动服务</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"The <span class="variable">$file</span> is starting..."</span></span><br><span class="line">	nohup java -jar <span class="variable">$currentDir</span><span class="variable">$file</span> -Djava.security.egd=file:/dev/urandom &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"nohup java -jar <span class="variable">$file</span> -Djava.security.egd=file:/dev/urandom &gt; /dev/null 2&gt;&amp;1 &amp;"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">FROM node</span><br><span class="line">RUN mkdir -p /var/www/html/ </span><br><span class="line">RUN npm install -g yarn</span><br><span class="line">WORKDIR /var/www/html</span><br><span class="line">EXPOSE 3000</span><br><span class="line">CMD [<span class="string">"npm"</span>,<span class="string">"start"</span>]</span><br></pre></td></tr></table></figure>

<h2 id="jenkins-jar-rollback"><a href="#jenkins-jar-rollback" class="headerlink" title="jenkins-jar-rollback"></a>jenkins-jar-rollback</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#参数化构建解释 : </span></span><br><span class="line"><span class="comment">#   deploy_status : deploy 发布; rollBack 回滚</span></span><br><span class="line"><span class="comment">#   rollBackVersion : 回滚到的版本(如果选择了deploy发布请忽略), 这个版本号是jenkins内部构建的版本号</span></span><br><span class="line"><span class="comment">#	module : 使用的是多选框check boxes, 要构建/回滚的模块, 勾选几个模块则构建/回滚几个模块</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">deploy</span></span>() &#123;</span><br><span class="line">  <span class="built_in">export</span> BUILD_ID=DONTKILLME</span><br><span class="line">  archiveDir=/data/backup/<span class="variable">$&#123;JOB_NAME&#125;</span>/<span class="variable">$&#123;BUILD_NUMBER&#125;</span></span><br><span class="line">  <span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$archiveDir</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">      mkdir -p <span class="variable">$archiveDir</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  </span><br><span class="line">  number=`date -d <span class="string">"today"</span> +<span class="string">"%Y%m%d_<span class="variable">$&#123;BUILD_NUMBER&#125;</span>"</span>`</span><br><span class="line">  IFS=<span class="string">","</span></span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$&#123;module&#125;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="comment">#项目打包</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$file</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -f <span class="string">"build.gradle"</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">cd</span> ../</span><br><span class="line">      <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    gradle clean</span><br><span class="line">    gradle build</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#归档</span></span><br><span class="line">    cp <span class="variable">$&#123;WORKSPACE&#125;</span>/<span class="variable">$file</span>/build/libs/*.jar <span class="variable">$archiveDir</span>/<span class="variable">$file</span><span class="string">"-"</span><span class="variable">$number</span>.jar</span><br><span class="line">    </span><br><span class="line">    publishDir=<span class="string">"/data/project/<span class="variable">$&#123;JOB_NAME&#125;</span>/<span class="variable">$file</span>"</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$publishDir</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">      mkdir -p <span class="variable">$publishDir</span>/backup</span><br><span class="line">      ln -s /data/project/app2.sh <span class="variable">$publishDir</span>/app.sh</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$publishDir</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#发布</span></span><br><span class="line">    projectRunning=`ls -t | grep jar | head -n 1`</span><br><span class="line">    <span class="comment">## 停止服务</span></span><br><span class="line">    appId=`ps -ef |grep java|grep <span class="variable">$projectRunning</span>|awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$appId</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">kill</span> <span class="variable">$appId</span></span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> &#123;5..1&#125;; <span class="keyword">do</span></span><br><span class="line">          sleep 1	</span><br><span class="line">      <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    rm -f <span class="variable">$publishDir</span>/*.jar</span><br><span class="line">    cp <span class="variable">$&#123;WORKSPACE&#125;</span>/<span class="variable">$file</span>/build/libs/*.jar <span class="variable">$moduleName</span></span><br><span class="line">    <span class="comment">## 启动服务</span></span><br><span class="line">    nohup java -jar <span class="variable">$moduleName</span> -Djava.security.egd=file:/dev/urandom -XX:+UseG1GC -XX:+HeapDumpOnOutOfMemoryError -Xms512M -Xmx4G &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$&#123;WORKSPACE&#125;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"本次发布的模块有:<span class="variable">$&#123;module&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">rollBack</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;rollBackVersion&#125;</span>"</span> == <span class="string">""</span> ] || [ ! -d <span class="string">"/data/backup/<span class="variable">$&#123;JOB_NAME&#125;</span>/<span class="variable">$&#123;rollBackVersion&#125;</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"参数错误:回滚至的版本号错误!"</span></span><br><span class="line">    <span class="built_in">exit</span> 1;</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"版本回滚至[#"</span><span class="variable">$rollBackVersion</span><span class="string">"], 此次版本发布的修改包有:"</span>;</span><br><span class="line">  ls /data/backup/<span class="variable">$&#123;JOB_NAME&#125;</span>/<span class="variable">$&#123;rollBackVersion&#125;</span></span><br><span class="line">  </span><br><span class="line">  archiveDir=/data/backup/<span class="variable">$&#123;JOB_NAME&#125;</span>/<span class="variable">$&#123;rollBackVersion&#125;</span></span><br><span class="line">  IFS=<span class="string">","</span></span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$&#123;module&#125;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">"/data/project/<span class="variable">$&#123;JOB_NAME&#125;</span>/<span class="variable">$file</span>"</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#发布</span></span><br><span class="line">    projectRunning=`ls -t | grep jar | head -n 1`</span><br><span class="line">    <span class="comment">## 停止服务</span></span><br><span class="line">    appId=`ps -ef |grep java|grep <span class="variable">$projectRunning</span>|awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$appId</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">kill</span> <span class="variable">$appId</span></span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> &#123;5..1&#125;; <span class="keyword">do</span></span><br><span class="line">          sleep 1	</span><br><span class="line">      <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    rm -f <span class="variable">$publishDir</span>/*.jar</span><br><span class="line">    cp <span class="variable">$archiveDir</span>/*.jar .</span><br><span class="line">    <span class="comment">## 启动服务</span></span><br><span class="line">    nohup java -jar <span class="variable">$moduleName</span> -Djava.security.egd=file:/dev/urandom -XX:+UseG1GC -XX:+HeapDumpOnOutOfMemoryError -Xms512M -Xmx4G &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$&#123;WORKSPACE&#125;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$deploy_status</span> <span class="keyword">in</span></span><br><span class="line">	deploy)</span><br><span class="line">	deploy;;</span><br><span class="line"></span><br><span class="line">	rollBack)</span><br><span class="line">	rollBack;;</span><br><span class="line"></span><br><span class="line">	*)</span><br><span class="line">	<span class="built_in">exit</span>;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>
        
    </section>
</article>




<a id="pageprev" href="/2020/02/17/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%96%87%E6%A1%A3/" class="article-prev" title="以太坊文档（工作笔记）"><i class="icon-arrow-left"></i></a>




            </div>
        </div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?e4027971a230b210f4671f485b33846a";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
</footer>

    </main>

    <script type="text/javascript" src="https://unpkg.com/jquery@1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle('normal', slideDone);
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp('normal', slideDone);
            }, 3000);
        }

        function slideDone() {
            if (nodes.navInner.css('display') !== 'none') {
                nodes.navInner.css('display', '');
            }
        }

        $(window).on('resize', function() {
            console.log($(this).width())
            if ($(this).width() > 960) {
                nodes.navInner.css('display', '');
            }
        });
    });
    </script>
    
        
<script src="/js/scrollspy.min.js"></script>

        <script type="text/javascript">
        $(document.body).scrollspy({target: '#aside-inner'});

        $(window).on('resize', function() {
            var hw = $('#header').width();
            var ww = $('#wrapper').width();
            var space = ($(this).width() - hw - ww) / 2 / 2;

            var pageprev = $('#pageprev');
            var pagenext = $('#pagenext');
            var avg = (pageprev.width() + pagenext.width()) / 2

            if(space > avg) {
                var len = space - avg / 2;
                var styles = {position: 'fixed', top: '50%', marginTop: - (pageprev.width() + pagenext.width()) / 4}
                pageprev.css($.extend({left: hw + len}, styles));
                pagenext.css($.extend({right: len}, styles));
            } else {
                pageprev.removeAttr('style');
                pagenext.removeAttr('style');
            }
        }).trigger('resize');
        </script>
    

</body>
</html>
